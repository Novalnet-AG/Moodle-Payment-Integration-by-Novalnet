/**
 * Novalent payment plugin
 *
 * JavaScript for configuring API credentials.
 *
 * @author       Novalnet
 * @module     paygw_novalnet/gateway_settings
 * @copyright(C) Novalnet. All rights reserved. <https://www.novalnet.de/>
 * @license https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("paygw_novalnet/gateway_settings",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){var SELECTORS={SELECTED_TARIFF:'[name="novalnet_tariff_id"]',FORM_PAYMENTS:["CREDITCARD","DIRECT_DEBIT_SEPA","INVOICE","PREPAYMENT","CASHPAYMENT","GOOGLEPAY","APPLEPAY","PAYPAL","GUARANTEED_DIRECT_DEBIT_SEPA","GUARANTEED_INVOICE","INSTALMENT_INVOICE","INSTALMENT_DIRECT_DEBIT_SEPA"]},handleWebhookConfigure=function(webhook_url){const request={methodname:"paygw_novalnet_handle_webhook_configure",args:{novalnetApiKey:$.trim($('[name="novalnet_public_key"]').val()),novalnetKeyPassword:$.trim($('[name="novalnet_key_password"]').val()),novalnetWebhookUrl:webhook_url}};Ajax.call([request])[0].then((response=>{if(""!==(response=JSON.parse(response.response)).result.status&&"SUCCESS"==response.result.status&&100==response.result.status_code)var message=Str.get_string("novalnet_webhook_configure_success","paygw_novalnet"),type="success";else message=response.result.status_text,type="error";Notification.addNotification({message:message,type:type})}))},fillNovalnetDetails=function(){const request={methodname:"paygw_novalnet_get_merchant_details",args:{novalnetApiKey:$.trim($('[name="novalnet_public_key"]').val()),novalnetKeyPassword:$.trim($('[name="novalnet_key_password"]').val()),id:$.trim($('[name="id"]').val()),accountid:$.trim($('[name="accountid"]').val()),gateway:$.trim($('[name="gateway"]').val())}};Ajax.call([request])[0].then((response=>{""!==(response=JSON.parse(response.response)).result.status&&"SUCCESS"==response.result.status&&100==response.result.status_code?(function(tariff){var tariffElement=$('[name="novalnet_tariff_id"]'),saved_tariff=$('[name="novalnet_selected_tariff"]').val();for(var tariff_id in"text"==tariffElement.prop("type")&&tariffElement.replaceWith('<select class="form-select" name="novalnet_tariff_id" id="id_novalnet_tariff_id"></select>'),tariffElement.empty(),tariff){var tariff_type=tariff[tariff_id].type,tariff_value=tariff[tariff_id].name;tariffElement.append($("<option>",{value:$.trim(tariff_id),text:$.trim(tariff_value)}).attr("tariff_type",$.trim(tariff_type))),saved_tariff===$.trim(tariff_id)&&(tariffElement.val($.trim(tariff_id)),$('[name="novalnet_tariff_type"]').val($.trim(tariff_type)))}}(response.merchant.tariff),function(payment_types){var paymentElement=$('[name="novalnet_active_payments[]"]'),testPaymentElement=$('[name="novalnet_test_mode_payments[]"]'),novalnetPayments=["ALIPAY","APPLEPAY","BANCONTACT","BLIK","CASHPAYMENT","CASH_ON_DELIVERY","CREDITCARD","DIRECT_DEBIT_ACH","DIRECT_DEBIT_SEPA","EPS","GIROPAY","GOOGLEPAY","GUARANTEED_DIRECT_DEBIT_SEPA","GUARANTEED_INVOICE","IDEAL","INSTALMENT_DIRECT_DEBIT_SEPA","IDEAL","INSTALMENT_INVOICE","INVOICE","PREPAYMENT","MBWAY","MULTIBANCO","ONLINE_BANK_TRANSFER","ONLINE_TRANSFER","PAYCONIQ","PAYPAL","POSTFINANCE","POSTFINANCE_CARD","PRZELEWY24","TRUSTLY","TWINT","WECHATPAY"],savedPayments=$('[name="novalnet_selected_payments"]').val();savedPayments=savedPayments?savedPayments.split(","):[];var savedTestPayments=$('[name="novalnet_selected_test_payments"]').val();savedTestPayments=savedTestPayments?savedTestPayments.split(","):[],paymentElement.empty(),testPaymentElement.empty(),payment_types.forEach((function(novalnetPayment){if(-1!==$.inArray(novalnetPayment,novalnetPayments)){var strings=[{key:novalnetPayment,component:"paygw_novalnet"}];if(Str.get_strings(strings).then((function(langStrings){var optionText=langStrings&&langStrings.length?langStrings:novalnetPayment;function addOptionIfNotExists(element,value,text){0===element.find('option[value="'.concat(value,'"]')).length&&element.append($("<option>",{value:$.trim(value),text:text}))}function selectOptionIfInList(element,value,list){-1!==$.inArray(value,list)&&element.find('option[value="'.concat(value,'"]')).prop("selected",!0)}addOptionIfNotExists(paymentElement,novalnetPayment,optionText),addOptionIfNotExists(testPaymentElement,novalnetPayment,optionText),selectOptionIfInList(paymentElement,novalnetPayment,savedPayments),selectOptionIfInList(testPaymentElement,novalnetPayment,savedTestPayments)})),SELECTORS.FORM_PAYMENTS.includes(novalnetPayment)){var selectedHeaderId="#id_novalnet_"+novalnetPayment.toLowerCase()+"_settings";$(selectedHeaderId).show()}}}))}(response.merchant.payment_types)):(nullBasicParams(),Notification.addNotification({message:response.result.status_text,type:"error"}))}))},nullBasicParams=function(){$('[name="novalnet_active_payments[]"]').empty(),$('[name="novalnet_test_mode_payments[]"]').empty(),$('[name="novalnet_tariff_id"]').empty(),$("#novalnet_tariff_id").find("option").remove()};return{init:function(formId){var selectedTariff=$("#"+formId).find(SELECTORS.SELECTED_TARIFF).val();selectedTariff&&$('[name="novalnet_selected_tariff"]').val(selectedTariff),SELECTORS.FORM_PAYMENTS.forEach((function(method){var headerId="#id_novalnet_"+method.toLowerCase()+"_settings";$(headerId).hide()})),$('[name="novalnet_public_key"]').length&&$('[name="novalnet_key_password"]').length?($("#novalnet_tariff_id").prop("readonly",!0),""!==$.trim($('[name="novalnet_public_key"]').val())&&""!==$.trim($('[name="novalnet_key_password"]').val())?fillNovalnetDetails():nullBasicParams(),$('[name="novalnet_public_key"], [name="novalnet_key_password"]').on("input change",(function(e){""!==$.trim($('[name="novalnet_public_key"]').val())&&""!==$.trim($('[name="novalnet_key_password"]').val())?"input"===e.type?null!=e.originalEvent.inputType&&"insertFromPaste"===e.originalEvent.inputType&&fillNovalnetDetails():fillNovalnetDetails():nullBasicParams()})).change()):nullBasicParams(),$('[name="webhook_configure"]').on("click",(function(){if(void 0===$('[name="novalnet_webhook_url"]')||""===$('[name="novalnet_webhook_url"]').val()){var webhook_url_error=Str.get_string("novalnet_webhook_url_error","paygw_novalnet");return Notification.alert("Error",webhook_url_error),!1}var webhook_url=$.trim($('[name="novalnet_webhook_url"]').val());if(!/(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/.test(webhook_url)){webhook_url_error=Str.get_string("novalnet_webhook_url_error","paygw_novalnet");return Notification.alert("Error",webhook_url_error),!1}Str.get_strings([{key:"confirm",component:"moodle"},{key:"novalnet_webhook_notice",component:"paygw_novalnet"},{key:"confirm",component:"moodle"},{key:"cancel",component:"moodle"}]).done((function(strings){Notification.confirm(strings[0],strings[1],strings[2],strings[3],(function(){handleWebhookConfigure(webhook_url)}))})).fail(Notification.exception)})).change(),$('[name="novalnet_active_payments[]"]').on("change",(function(){var selectedValues=$(this).val()||[];$('[name="novalnet_selected_payments"]').val(selectedValues.join(","))})),$('[name="novalnet_test_mode_payments[]"]').on("change",(function(){var selectedTestValues=$(this).val()||[];$('[name="novalnet_selected_test_payments"]').val(selectedTestValues.join(","))}))}}}));

//# sourceMappingURL=gateway_settings.min.js.map